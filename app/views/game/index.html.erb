<meta http-equiv="refresh" content="3">

<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold mb-4">Territory Game <span class="text-sm text-gray-500">(auto-refreshes every 3s)</span></h1>

  <div class="grid grid-cols-2 gap-4 mb-6">
    <% @factions.each do |faction| %>
      <div class="p-4 border-2 rounded" style="border-color: <%= faction.color %>">
        <h2 class="text-xl font-bold" style="color: <%= faction.color %>"><%= faction.name %> Faction</h2>
        <p>Territories: <%= faction.territories.count %></p>
        <p>Players: <%= faction.players.count %></p>
      </div>
    <% end %>
  </div>

  <% if @human_player.current_position %>
    <div class="mb-4 p-4 bg-blue-100 rounded">
      <p class="font-bold">Your Position: (<%= @human_player.current_position.x %>, <%= @human_player.current_position.y %>)</p>
      <p>Click an adjacent territory to move there.</p>
    </div>
  <% end %>

  <% if flash[:notice] %>
    <div class="mb-4 p-4 bg-green-100 border border-green-400 rounded">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <% if flash[:alert] %>
    <div class="mb-4 p-4 bg-red-100 border border-red-400 rounded">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <div class="border-2 border-gray-300 inline-block bg-gray-100 p-2">
    <% (0..19).each do |y| %>
      <div class="flex">
        <% (0..9).each do |x| %>
          <% territory = @territories.find { |t| t.x == x && t.y == y } %>
          <%
            is_current = @human_player.current_position&.x == x && @human_player.current_position&.y == y
            bg_color = if is_current
              "bg-yellow-300 ring-4 ring-yellow-500"
            elsif territory.faction
              case territory.faction.name
              when "Red" then "bg-red-200"
              when "Blue" then "bg-blue-200"
              else "bg-gray-200"
              end
            else
              "bg-gray-50"
            end

            player_count = territory.players.count
          %>
          <%= form_with url: move_game_index_path, method: :post, local: true do |f| %>
            <%= f.hidden_field :x, value: x %>
            <%= f.hidden_field :y, value: y %>
            <%= f.submit "#{x},#{y}\n#{player_count > 0 ? player_count : ''}",
                class: "w-16 h-16 m-0.5 text-xs border border-gray-400 cursor-pointer hover:ring-2 hover:ring-blue-400 #{bg_color}" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="mt-6">
    <h2 class="text-xl font-bold mb-2">Legend</h2>
    <ul class="list-disc list-inside">
      <li><span class="inline-block w-4 h-4 bg-red-200 border border-gray-400"></span> Red Faction Territory</li>
      <li><span class="inline-block w-4 h-4 bg-blue-200 border border-gray-400"></span> Blue Faction Territory</li>
      <li><span class="inline-block w-4 h-4 bg-gray-50 border border-gray-400"></span> Neutral Territory</li>
      <li><span class="inline-block w-4 h-4 bg-yellow-300 ring-4 ring-yellow-500"></span> Your Current Position</li>
      <li>Number in tile = players on that territory</li>
    </ul>
  </div>
</div>
