# Territory Game - Session Log - October 22, 2025

## Session Summary

Built a working prototype of a massive-scale persistent territory control game with strategic depth, deployable to production.

**Duration**: ~3 hours
**Status**: ‚úÖ Fully playable prototype with strategic mechanics
**Running At**: http://localhost:3001/territory_game

---

## What Was Built

### Core Game Mechanics

**1. Territory Control System**
- 10√ó20 grid (200 territories)
- 2 factions (Red, Blue) with 10 players each (1 human + 9 bots per faction)
- Players move to adjacent tiles using arrow keys
- Territory control based on player presence (most players = control)

**2. Strategic Rally Point System**
- 3 rally points on vertical center line: (5,5), (5,10), (5,15)
- Rally points worth **3x** in control calculations
- Control rally points ‚Üí respawn there when defeated
- Creates strategic focal points for battles

**3. Combat Mechanics (2:1 Push-Off)**
- If outnumbered 2:1 or more on a tile ‚Üí respawn at your rally point
- NO permanent elimination (all players stay in game)
- Encourages tactical grouping vs spreading out
- Prevents death-ball stacking

**4. Win Condition**
- Reach **60% control** to win
- Control percentage weighted by territory value (rally points = 3x)
- Trophy (üèÜ) shown when faction hits 60%

**5. Bot AI**
- Prioritize uncaptured rally points (-200 score)
- Defend controlled rally points (-50 score)
- Avoid 2:1 push-off situations (+100 penalty)
- Prefer neutral/friendly territories (-30 score)

**6. World Tick System**
- Runs every 5 seconds via background job
- Resolves combat ‚Üí updates territory control ‚Üí moves bots ‚Üí updates faction power
- Creates living world that evolves without constant player input

**7. UI/UX**
- Keyboard controls (arrow keys to move)
- Auto-refresh every 3 seconds
- Real-time faction control percentages
- Rally points marked with yellow ‚òÖ
- Color-coded territories (red/blue/neutral)
- Player position highlighted in yellow

---

## Technical Implementation

### Stack
- **Rails 8.0** with Ruby 3.3.4
- **Tailwind CSS** for styling
- **Solid Queue** for background jobs (NO Redis/Sidekiq)
- **SQLite** for development database

### Key Files Created

**Models:**
- `app/models/faction.rb` - Team management, control calculations
- `app/models/player.rb` - Player movement, position tracking
- `app/models/territory.rb` - Territory control, adjacency checks
- `app/models/player_position.rb` - Join table for player locations
- `app/models/action.rb` - Future: action queue system

**Services:**
- `app/services/world_tick_service.rb` - Main game loop processor
- `app/services/bot_ai_service.rb` - Simple bot decision making

**Background Jobs:**
- `app/jobs/world_tick_job.rb` - Solid Queue recurring job
- `bin/tick_loop` - Development script for fast ticks (every 5s)

**Views:**
- `app/views/game/index.html.erb` - Main game interface
- `app/views/layouts/application.html.erb` - Layout with Tailwind

**Config:**
- `config/recurring.yml` - Solid Queue job schedules
- `config/routes.rb` - Scoped under /territory_game
- `db/seeds.rb` - Creates factions, players, territories, rally points

---

## Database Schema

```ruby
Faction
  - name (Red/Blue)
  - color (hex code)
  - total_power (weighted territory count)

Player
  - faction_id
  - name
  - is_bot (boolean)
  - resources (future use)
  - power_level (future use)
  - last_active_at

Territory
  - x, y (grid coordinates)
  - faction_id (nullable - can be neutral)
  - player_count (cache)
  - is_rally_point (boolean)

PlayerPosition (join table)
  - player_id
  - territory_id
```

---

## Game Design Decisions

### What We Implemented (Phase 1)
‚úÖ **Rally Points** - Strategic focal points worth 3x
‚úÖ **2:1 Combat** - Push-off mechanic prevents death-balling
‚úÖ **60% Win Condition** - Clear goal that's achievable
‚úÖ **Smart Bot AI** - Prioritizes rally points and avoids bad fights
‚úÖ **No Permanent Elimination** - Always 10v10, prevents snowballing

### What We Rejected
‚ùå **Gradual Capture (-10 to +10)** - Too complex, hard to visualize
‚ùå **Permanent Elimination** - Creates unwinnable states
‚ùå **3+ Advantage Kills** - Enables death-ball stacking

### Design Rationale (from Game Design Expert)
The simplified mechanics create strategic tension without overwhelming complexity:
- **Spread vs Stack**: Capture more tiles OR win rally point fights
- **Risk vs Safety**: Attack enemy rally OR defend yours
- **Teamwork**: 1 human + 9 bots can tip battles at rally points
- **Clear Feedback**: Control % visible every tick, rally captures obvious

---

## Technical Challenges Solved

### 1. Tailwind CSS Not Rendering
**Problem**: Tiles showed as text instead of colored boxes
**Root Cause**: Tailwind JIT compiler hadn't scanned view files to generate CSS for new classes
**Solution**:
- Rebuilt Tailwind CSS: `bin/rails tailwindcss:build`
- Precompiled assets: `bin/rails assets:precompile`
- Restarted server to load new CSS with updated fingerprint

### 2. Asset Path Issues with Scoped Routes
**Problem**: CSS 404s because of `/territory_game` path scope
**Root Cause**: `config.relative_url_root` conflicted with `scope path:` in routes
**Solution**: Removed `relative_url_root`, let assets load from root `/assets/` path

### 3. Background Jobs Not Running
**Problem**: World felt static, no tick processing
**Root Cause**: Solid Queue worker not started
**Solution**: Created `bin/tick_loop` script for development (runs every 5s)

---

## Current Status

### What Works ‚úÖ
- Map renders with colored tiles
- Arrow key movement
- Combat system (2:1 push-off)
- Rally point mechanics
- Bot AI behavior
- Control percentage calculations
- Win condition detection
- Auto-refresh UI
- World tick processing

### What's Missing (Not Broken, Just Future Features)
- Offline player delegation system
- Captain/leadership mechanics
- Multiple concurrent games
- Player authentication
- More than 2 factions
- Larger maps
- Victory celebrations/reset flow

---

## Future Features (Documented in docs/FUTURE_FEATURES.md)

### High Priority: Offline Mechanics
**Concept**: Players contribute even when offline by delegating to a captain

**Mechanics:**
- When you log off, you stay on your tile
- Your power delegates to highest-ranked player (the "Captain")
- Captain shows "+3 offline" to indicate delegated players
- If defeated while offline ‚Üí respawn at rally point
- Some bots simulate going offline (gives human leadership experience)

**Benefits:**
- Casual-friendly (contribute 24/7 without being online)
- Natural squad mechanics emerge
- Strategic (where you log off matters)
- Feels like commanding forces

### Other Future Features
- Player progression across rounds
- Faction abilities/perks
- Territory modifiers (chokepoints, hazards)
- Simple chat/ping system
- Scaling to 5 factions, 50+ players per faction

---

## Files Changed This Session

### New Files Created
```
app/models/faction.rb
app/models/player.rb
app/models/territory.rb
app/models/player_position.rb
app/models/action.rb
app/services/world_tick_service.rb
app/services/bot_ai_service.rb
app/jobs/world_tick_job.rb
app/controllers/game_controller.rb
app/views/game/index.html.erb
db/migrate/20251022233420_create_factions.rb
db/migrate/20251022233424_create_players.rb
db/migrate/20251022233428_create_territories.rb
db/migrate/20251022233431_create_player_positions.rb
db/migrate/20251022233435_create_actions.rb
db/migrate/20251022233617_make_territory_faction_optional.rb
db/migrate/20251022235544_add_rally_point_to_territories.rb
bin/tick_loop
docs/FUTURE_FEATURES.md
docs/SESSION_2025_10_22.md
```

### Modified Files
```
config/routes.rb - Added game routes scoped under /territory_game
config/recurring.yml - Added world tick job schedule
db/seeds.rb - Creates game world with rally points
app/views/layouts/application.html.erb - Fixed Tailwind CSS loading
Procfile.dev - Added Tailwind watch
```

---

## How to Run Locally

### Start All Services
```bash
cd /Users/zac/zac_ecosystem/apps/territory_game

# Terminal 1: Rails server
bin/rails server -p 3001

# Terminal 2: Tailwind watcher (auto-rebuilds CSS)
bin/rails tailwindcss:watch

# Terminal 3: World tick loop (game simulation)
bin/tick_loop
```

**OR use bin/dev to run all at once:**
```bash
bin/dev
# Then manually run: bin/tick_loop
```

### Visit Game
http://localhost:3001/territory_game

### Reset/Reseed Database
```bash
bin/rails db:reset
```

---

## Next Steps

### Before Production Deployment

**1. Add Production Config**
- Set `config.relative_url_root = "/territory_game"` in `config/environments/production.rb`
- Configure nginx routing (see CLAUDE.md for pattern)
- Set up systemd service for world tick job

**2. Test at Scale**
- Increase to 100 players (50 per faction)
- Test with 5 factions instead of 2
- Verify tick performance with more entities

**3. Polish**
- Victory screen when faction hits 60%
- Round timer (count up from start)
- Better mobile responsive layout
- Onboarding/tutorial

**4. Optional Before Deploy**
- Player authentication (simple password per player?)
- Multiple concurrent games/rounds
- Leaderboard/stats

### Immediate Playtesting Goals
1. Does the 2:1 combat feel fair?
2. Are rally points creating interesting battles?
3. Can you reach 60% in reasonable time (5-10 minutes)?
4. Do bots behave intelligently enough?

---

## Performance Notes

**Current Scale:**
- 20 players
- 200 territories
- Tick every 5 seconds
- ~0.5s to process full tick

**Expected Scale:**
- 100 players
- 1000 territories
- Tick every 30-60 seconds
- Should stay under 2s per tick

**Bottlenecks to Watch:**
- Territory control calculations (200+ territories)
- Bot AI pathfinding (19 bots √ó 4 adjacent tiles)
- Player position queries (joins)

**Optimizations Available:**
- Cache faction territory counts
- Batch update queries
- Index player_positions by territory_id
- Only process territories with players

---

## Git Commits This Session

```
d173918 Initial commit - generated from template
4de5dcb Initial territory game prototype: 2 factions, 20 players, world tick system
2e1cb4f Fix Tailwind CSS loading in layout
536612c Add tick loop script and auto-refresh UI (every 5s ticks, 3s refresh)
6a9f32f Add keyboard controls (arrow keys) and remove coordinates from tiles
ff451d5 Add strategic gameplay: rally points, 2:1 combat, control percentage, 60% win condition
a744d02 Document future features: offline mechanics, captain system, bot delegation
```

---

## Repository Setup

**Local Path**: `/Users/zac/zac_ecosystem/apps/territory_game`
**GitHub**: Need to create repo and push

### Create GitHub Repo and Push
```bash
# Create repo on GitHub: territory_game
gh repo create territory_game --public --source=. --remote=origin

# OR manually:
# 1. Create repo at github.com/zrandles/territory_game
# 2. Then:
git remote add origin git@github.com:zrandles/territory_game.git
git branch -M main
git push -u origin main
```

---

## Key Learnings

### What Worked Well
1. **Game Design Expert consultation** - Prevented over-engineering, focused on strategic depth
2. **Simple bot AI** - Just 4 priorities creates emergent behavior
3. **Rally points** - Single mechanic creates multiple strategic decisions
4. **Rails for this** - Good fit for turn-based/tick-based game
5. **Prototype first** - Got playable game in 3 hours vs planning for weeks

### What Was Tricky
1. **Tailwind JIT compilation** - Had to manually rebuild CSS for new classes
2. **Asset paths with scoped routes** - relative_url_root conflicts
3. **Background job setup** - Solid Queue config was non-obvious
4. **Balance testing** - Hard to know if mechanics work without playing

### What Would Speed Up Next Time
1. Always run `bin/rails tailwindcss:watch` during development
2. Set up asset pipeline correctly from start
3. Create background job wrapper script earlier
4. Playtest earlier and more often

---

## Notes for Future Sessions

### If Resuming Development
1. Read this session log
2. Read `docs/FUTURE_FEATURES.md` for roadmap
3. Check `git log --oneline` for recent changes
4. Run `bin/rails db:seed` if database is stale
5. Start all 3 services (server, tailwind, tick_loop)

### If Deploying to Production
1. Follow deployment pattern from CLAUDE.md
2. Use Capistrano: `cap production deploy`
3. Configure nginx (see CLAUDE.md nginx section)
4. Set up systemd for world tick job
5. Test on production before announcing

### If Adding Features
1. Check `docs/FUTURE_FEATURES.md` for planned features
2. Consult game-design-expert for balance/mechanics questions
3. Keep tick processing under 2 seconds
4. Test with 100 bots before deploying
5. Update this session log

---

**Session End Time**: ~8:00 PM PST
**Status**: Ready for playtesting and GitHub push
**Next Session**: Playtest, gather feedback, implement offline mechanics
